generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  name          String?
  email         String?        @unique
  mobileNumber  String?        @unique
  authProvider  AuthProvider
  createdAt     DateTime       @default(now())
  role          UserRole       @default(USER)
  image         String?
  isBlacklisted Boolean        @default(false)
  isFreeUser    Boolean        @default(false)
  bookings      Booking[]
  notifications Notification[]
  otps          Otp[]
  userPackages  UserPackage[]
  payments      Payment[]
}

model Policy {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  codeHash  String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Slot {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  startTime DateTime
  endTime   DateTime
  price     Float    @default(600)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([date, startTime])
}

model Booking {
  id                 String          @id @default(cuid())
  userId             String?
  date               DateTime        @db.Date
  startTime          DateTime
  endTime            DateTime
  status             BookingStatus   @default(BOOKED)
  ballType           BallType        @default(TENNIS)
  playerName         String
  createdAt          DateTime        @default(now())
  discountAmount     Float?
  discountType       DiscountType?
  extraCharge        Float?
  operationMode      OperationMode   @default(WITH_OPERATOR)
  originalPrice      Float?
  pitchType          PitchType?
  price              Float?
  cancellationReason String?
  cancelledBy        String?
  createdBy          String?
  machineId          MachineId?
  isSuperAdminBooking Boolean        @default(false)
  user               User?           @relation(fields: [userId], references: [id])
  packageBooking     PackageBooking?

  @@unique([date, startTime, machineId, pitchType])
}

model BlockedSlot {
  id          String     @id @default(cuid())
  startDate   DateTime   @db.Date
  endDate     DateTime   @db.Date
  startTime   DateTime?
  endTime     DateTime?
  machineType BallType?
  pitchType   PitchType?
  reason      String?
  blockedBy   String
  createdAt   DateTime   @default(now())
  machineId   MachineId?
}

model Package {
  id               String             @id @default(cuid())
  name             String
  machineId        MachineId?
  machineType      MachineType
  ballType         PackageBallType?
  wicketType       PackageWicketType?
  timingType       TimingType
  totalSessions    Int
  validityDays     Int                @default(30)
  price            Float
  extraChargeRules Json?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  userPackages     UserPackage[]
}

model UserPackage {
  id              String            @id @default(cuid())
  userId          String
  packageId       String
  totalSessions   Int
  usedSessions    Int               @default(0)
  activationDate  DateTime          @default(now())
  expiryDate      DateTime
  status          UserPackageStatus @default(ACTIVE)
  amountPaid      Float
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  auditLogs       PackageAuditLog[]
  packageBookings PackageBooking[]
  package         Package           @relation(fields: [packageId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
}

model PackageBooking {
  id              String      @id @default(cuid())
  userPackageId   String
  bookingId       String      @unique
  sessionsUsed    Int         @default(1)
  extraCharge     Float       @default(0)
  extraChargeType String?
  createdAt       DateTime    @default(now())
  booking         Booking     @relation(fields: [bookingId], references: [id])
  userPackage     UserPackage @relation(fields: [userPackageId], references: [id])
}

model PackageAuditLog {
  id            String      @id @default(cuid())
  userPackageId String
  action        String
  details       Json?
  performedBy   String
  createdAt     DateTime    @default(now())
  userPackage   UserPackage @relation(fields: [userPackageId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("INFO")
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

enum UserRole {
  USER
  ADMIN
}

enum AuthProvider {
  GOOGLE
  OTP
}

enum BookingStatus {
  BOOKED
  CANCELLED
  DONE
}

enum BallType {
  TENNIS
  LEATHER
  MACHINE
}

enum MachineId {
  GRAVITY
  YANTRA
  LEVERAGE_INDOOR
  LEVERAGE_OUTDOOR
}

enum PitchType {
  ASTRO
  TURF
  CEMENT
  NATURAL
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum OperationMode {
  WITH_OPERATOR
  SELF_OPERATE
}

enum MachineType {
  LEATHER
  TENNIS
}

enum PackageBallType {
  MACHINE
  LEATHER
  BOTH
}

enum PackageWicketType {
  CEMENT
  ASTRO
  NATURAL
  BOTH
}

enum TimingType {
  DAY
  EVENING
  BOTH
}

enum UserPackageStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentType {
  SLOT_BOOKING
  PACKAGE_PURCHASE
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  amount            Float
  currency          String        @default("INR")
  status            PaymentStatus @default(CREATED)
  paymentType       PaymentType

  // Razorpay fields
  razorpayOrderId   String        @unique
  razorpayPaymentId String?
  razorpaySignature String?

  // Reference to what was paid for
  bookingIds        String[]      // Array of booking IDs for slot bookings
  userPackageId     String?       // For package purchases

  // Refund tracking
  refundId          String?
  refundAmount      Float?
  refundedAt        DateTime?

  // Metadata
  metadata          Json?         // Store any extra info (slot details, package info, etc.)
  failureReason     String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  user              User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([razorpayOrderId])
  @@index([status])
}
